import './controls-ui.css.proxy.js';
/* src/compound-components/player-ui/controls-ui.svelte generated by Svelte v3.24.0 */
import {
	SvelteComponent,
	append,
	attr,
	detach,
	element,
	init,
	insert,
	listen,
	noop,
	safe_not_equal,
	set_style,
	space
} from "/web-piano/web_modules/svelte/internal.js";

import { MidiPlayer, MidiPlayerState } from "/web-piano/bundle/compound-components/midi-player/index.js";
import { createEventDispatcher } from "/web-piano/web_modules/svelte.js";

function create_fragment(ctx) {
	let center;
	let img;
	let img_src_value;
	let t;
	let div1;
	let div0;
	let mounted;
	let dispose;

	return {
		c() {
			center = element("center");
			img = element("img");
			t = space();
			div1 = element("div");
			div0 = element("div");
			if (img.src !== (img_src_value = /*buttonImage*/ ctx[1])) attr(img, "src", img_src_value);
			attr(img, "alt", "кнопка играть");
			attr(img, "class", "svelte-r2omvd");
			set_style(div0, "width", /*progress*/ ctx[0] + "%");
			attr(div0, "id", "greenBar");
			attr(div0, "class", "svelte-r2omvd");
			attr(div1, "id", "greyProgress");
			attr(div1, "class", "svelte-r2omvd");
		},
		m(target, anchor) {
			insert(target, center, anchor);
			append(center, img);
			append(center, t);
			append(center, div1);
			append(div1, div0);

			if (!mounted) {
				dispose = listen(img, "click", /*playBtnHandler*/ ctx[2]);
				mounted = true;
			}
		},
		p(ctx, [dirty]) {
			if (dirty & /*buttonImage*/ 2 && img.src !== (img_src_value = /*buttonImage*/ ctx[1])) {
				attr(img, "src", img_src_value);
			}

			if (dirty & /*progress*/ 1) {
				set_style(div0, "width", /*progress*/ ctx[0] + "%");
			}
		},
		i: noop,
		o: noop,
		d(detaching) {
			if (detaching) detach(center);
			mounted = false;
			dispose();
		}
	};
}

function instance($$self, $$props, $$invalidate) {
	var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {
		function adopt(value) {
			return value instanceof P
			? value
			: new P(function (resolve) {
						resolve(value);
					});
		}

		return new (P || (P = Promise))(function (resolve, reject) {
				function fulfilled(value) {
					try {
						step(generator.next(value));
					} catch(e) {
						reject(e);
					}
				}

				function rejected(value) {
					try {
						step(generator["throw"](value));
					} catch(e) {
						reject(e);
					}
				}

				function step(result) {
					result.done
					? resolve(result.value)
					: adopt(result.value).then(fulfilled, rejected);
				}

				step((generator = generator.apply(thisArg, _arguments || [])).next());
			});
	};

	let { fileInfo = undefined } = $$props;
	let { midiFileInfo = undefined } = $$props;
	const dispatch = createEventDispatcher();
	const player = new MidiPlayer();
	let playerState = player.getState();
	let progress = 0;
	player.onStateChange(event => $$invalidate(5, playerState = event.state));
	player.onProgressChange(event => $$invalidate(0, progress = event.progress));

	function loadSongUrl(filename) {
		return __awaiter(this, void 0, void 0, function* () {
			yield player.loadUrl("/web-piano/midi/" + filename);
			$$invalidate(3, midiFileInfo = player.getInfo());
		});
	}

	function startNewSong(info) {
		if (info) {
			loadSongUrl(info.filename);
		}
	}

	
	

	function playBtnHandler() {
		if (player.getState() === MidiPlayerState.playing) {
			player.stop();
		} else {
			player.play();
		}
	}

	const getButtonImage = state => state === MidiPlayerState.playing
	? "./pause.png"
	: "./play.png";

	$$self.$set = $$props => {
		if ("fileInfo" in $$props) $$invalidate(4, fileInfo = $$props.fileInfo);
		if ("midiFileInfo" in $$props) $$invalidate(3, midiFileInfo = $$props.midiFileInfo);
	};

	let buttonImage;

	$$self.$$.update = () => {
		if ($$self.$$.dirty & /*fileInfo*/ 16) {
			$: {
				startNewSong(fileInfo);
			}
		}

		if ($$self.$$.dirty & /*midiFileInfo*/ 8) {
			$: {
				dispatch("midiChanched", midiFileInfo);
			}
		}

		if ($$self.$$.dirty & /*playerState*/ 32) {
			$: $$invalidate(1, buttonImage = getButtonImage(playerState));
		}
	};

	return [progress, buttonImage, playBtnHandler, midiFileInfo, fileInfo];
}

class Controls_ui extends SvelteComponent {
	constructor(options) {
		super();
		init(this, options, instance, create_fragment, safe_not_equal, { fileInfo: 4, midiFileInfo: 3 });
	}
}

export default Controls_ui;